import{cs as O,ct as k,cu as U,cv as C,cw as V,cx as D,cy as J,cz as B,a as R,r as b,br as H,A as z,u as F,j as P,n as K,cA as W,bt as Y,cB as T,cC as G,bW as X,cD as Z,cE as ee,cF as te}from"./sanity-hHxQbr7i.js";import{c as re}from"./PresentationToolGrantsCheck-CZ0uWGLl.js";import{i as x}from"./DisplayedDocumentBroadcaster-BL7dCBqv.js";function se(t){if(Array.isArray(t)&&t.length>1&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives')}function ne(t){if(se(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function ie(t,e){const s=ne(e);function a(r){for(const n of s){let i=null;if(n.startsWith("r")&&(i=t({...r,_id:k(r._id,n)})),n==="drafts"&&(i=t({...r,_id:U(r._id)})),n==="published"&&(i=t({...r,_id:C(r._id)})),i)return{...i,_id:C(i._id),_originalId:i._id}}return null}return function(r){return a(r)}}function ae(t,e,s,a,r){var h,d;if(!e)return t;const n=ie(s,r),i=((d=(h=e.documents)==null?void 0:h.map)==null?void 0:d.call(h,n))||[];return O(JSON.parse(JSON.stringify(t)),(c,l)=>{const f=V(l,e);if(!f)return c;const{mapping:u,pathSuffix:S}=f;if(u.type!=="value"||u.source.type!=="documentValue")return c;const v=e.documents[u.source.document],q=e.paths[u.source.path];if(v){const E=D(q+S),g=J(E),w=i[u.source.document];if(!w)return c;const I=w?B(w,g,c):c;return c===I?c:a(I,{cachedDocument:w,previousValue:c,sourceDocument:v,sourcePath:E})}return c})}function ue(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const oe={messages:[],resets:0};function ce(t){const e=R.c(3),[s,a]=b.useReducer(ue,oe),[r,n]=b.useState(null);if(r!==null)throw r;let i,h;return e[0]!==t.live?(i=()=>{const d=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:a,error:c=>n(c instanceof Error?c:new Error("Unexpected error in useLiveEvents",{cause:c}))});return()=>d.unsubscribe()},h=[t.live],e[0]=t.live,e[1]=i,e[2]=h):(i=e[1],h=e[2]),b.useEffect(i,h),b.useDeferredValue(s)}const le=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&ee(s)))return te(t)}}return t};function pe(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function fe(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,a=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),a.set(r,t.queries.get(r)));return{...t,queries:a,heartbeats:s}}function de(t,{payload:e}){const s=pe(e.perspective,e.query,e.params),a={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!x(t.queries.get(s),a))&&(n=new Map(t.queries),n.set(s,a)),{heartbeats:r,queries:n}}function he(t,e){switch(e.type){case"query-listen":return de(t,e);case"gc":return fe(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const ye={queries:new Map,heartbeats:new Map};function be(){const t=R.c(4),[e,s]=b.useReducer(he,ye);let a,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{const h=setInterval(()=>s({type:"gc"}),W);return()=>clearInterval(h)},r=[],t[0]=a,t[1]=r):(a=t[0],r=t[1]),b.useEffect(a,r);const n=b.useDeferredValue(e.queries);let i;return t[2]!==n?(i=[n,s],t[2]=n,t[3]=i):i=t[3],i}function Ae(t){const e=R.c(28),{controller:s,perspective:a,onLoadersConnection:r,onDocumentsOnPage:n}=t,[i,h]=b.useState(),[d,c]=be(),l=H(),f=z();let u,S;e[0]!==s||e[1]!==f||e[2]!==c||e[3]!==n||e[4]!==r||e[5]!==l?(u=()=>{if(s){const p=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},Y().provide({actors:re()}));return h(p),p.onStatus(r),p.on("loader/documents",m=>{m.projectId===l&&m.dataset===f&&n("loaders",m.perspective,m.documents)}),p.on("loader/query-listen",m=>{if(m.projectId===l&&m.dataset===f){if(typeof m.heartbeat=="number"&&m.heartbeat<T)throw new Error(`Loader query listen heartbeat interval must be at least ${T}ms`);c({type:"query-listen",payload:{perspective:m.perspective,query:m.query,params:m.params,heartbeat:m.heartbeat??!1}})}}),p.start()}return me},S=[s,f,c,n,r,l],e[0]=s,e[1]=f,e[2]=c,e[3]=n,e[4]=r,e[5]=l,e[6]=u,e[7]=S):(u=e[6],S=e[7]),b.useEffect(u,S);let v;e[8]!==a?(v=Z(a)?G:{apiVersion:X},e[8]=a,e[9]=v):v=e[9];const q=F(v);let E,g;e[10]!==q?(g=q.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=q,e[11]=g):g=e[11],E=g;const w=E;let I,A;e[12]!==a||e[13]!==i||e[14]!==f||e[15]!==l?(I=()=>{i&&i.post("loader/perspective",{projectId:l,dataset:f,perspective:a})},A=[i,a,l,f],e[12]=a,e[13]=i,e[14]=f,e[15]=l,e[16]=I,e[17]=A):(I=e[16],A=e[17]),b.useEffect(I,A);const _=b.useDeferredValue(t.liveDocument),M=ce(w);let y;e[18]!==d?(y=[...d.entries()],e[18]=d,e[19]=y):y=e[19];let o;return e[20]!==w||e[21]!==i||e[22]!==f||e[23]!==_||e[24]!==M||e[25]!==l||e[26]!==y?(o=P.jsx(P.Fragment,{children:y.map(p=>{const[m,L]=p,{query:Q,params:j,perspective:N}=L;return P.jsx($,{projectId:l,dataset:f,perspective:N,query:Q,params:j,comlink:i,client:w,liveDocument:_,liveEventsMessages:M.messages},`${M.resets}:${m}`)})}),e[20]=w,e[21]=i,e[22]=f,e[23]=_,e[24]=M,e[25]=l,e[26]=y,e[27]=o):o=e[27],o}function me(){}function ve(t){const e=R.c(20),{projectId:s,dataset:a,perspective:r,query:n,client:i,liveDocument:h,params:d,comlink:c,liveEventsMessages:l}=t,{result:f,resultSourceMap:u,syncTags:S}=Ee({client:i,liveDocument:h,params:d,perspective:r,query:n,liveEventsMessages:l})||{};let v;e[0]!==a||e[1]!==s?(v=(w,I,A,_,M,y,o)=>{w==null||w.post("loader/query-change",{projectId:s,dataset:a,perspective:I,query:A,params:_,result:M,resultSourceMap:y,tags:o})},e[0]=a,e[1]=s,e[2]=v):v=e[2];const q=K(v);let E;e[3]!==c||e[4]!==q||e[5]!==d||e[6]!==r||e[7]!==n||e[8]!==f||e[9]!==u||e[10]!==S?(E=()=>{u&&q(c,r,n,d,f,u,S)},e[3]=c,e[4]=q,e[5]=d,e[6]=r,e[7]=n,e[8]=f,e[9]=u,e[10]=S,e[11]=E):E=e[11];let g;return e[12]!==c||e[13]!==d||e[14]!==r||e[15]!==n||e[16]!==f||e[17]!==u||e[18]!==S?(g=[c,d,r,n,f,u,S],e[12]=c,e[13]=d,e[14]=r,e[15]=n,e[16]=f,e[17]=u,e[18]=S,e[19]=g):g=e[19],b.useEffect(E,g),null}const $=b.memo(ve);$.displayName="Memo(QuerySubscription)";function Ee(t){const e=R.c(30),{liveDocument:s,client:a,query:r,params:n,perspective:i,liveEventsMessages:h}=t,[d,c]=b.useState(null),[l,f]=b.useState(null),[u,S]=b.useState(void 0);let v;e[0]!==h?(v=()=>new Set(h.map(ge)),e[0]=h,e[1]=v):v=e[1];const[q]=b.useState(v);let E;if(e[2]!==h||e[3]!==q||e[4]!==u){let y;e[6]!==q?(y=m=>!q.has(m.id),e[6]=q,e[7]=y):y=e[7];const o=h.filter(y);let p;e[8]!==u?(p=m=>m.tags.some(L=>u==null?void 0:u.includes(L)),e[8]=u,e[9]=p):p=e[9],E=o.findLast(p),e[2]=h,e[3]=q,e[4]=u,e[5]=E}else E=e[5];const g=E==null?void 0:E.id,[w,I]=b.useState(null);if(w)throw w;let A,_;e[10]!==a||e[11]!==g||e[12]!==n||e[13]!==i||e[14]!==r?(A=()=>{const y=new AbortController;return a.fetch(r,n,{lastLiveEventId:g,tag:"presentation-loader",signal:y.signal,perspective:i,filterResponse:!1,returnQuery:!1}).then(o=>{b.startTransition(()=>{c(p=>x(p,o.result)?p:o.result),f(p=>x(p,o.resultSourceMap)?p:o.resultSourceMap),S(p=>x(p,o.syncTags)?p:o.syncTags)})}).catch(o=>{(typeof o!="object"||(o==null?void 0:o.name)!=="AbortError")&&I(o)}),()=>{y.abort()}},_=[a,g,n,i,r],e[10]=a,e[11]=g,e[12]=n,e[13]=i,e[14]=r,e[15]=A,e[16]=_):(A=e[15],_=e[16]),b.useEffect(A,_);let M;e:{if(s&&l){let o;e[17]!==s||e[18]!==i||e[19]!==d||e[20]!==l?(o=we(s,d,i,l),e[17]=s,e[18]=i,e[19]=d,e[20]=l,e[21]=o):o=e[21];let p;e[22]!==l||e[23]!==u||e[24]!==o?(p={result:o,resultSourceMap:l,syncTags:u},e[22]=l,e[23]=u,e[24]=o,e[25]=p):p=e[25],M=p;break e}let y;e[26]!==d||e[27]!==l||e[28]!==u?(y={result:d,resultSourceMap:l,syncTags:u},e[26]=d,e[27]=l,e[28]=u,e[29]=y):y=e[29],M=y}return M}function ge(t){return t.id}function we(t,e,s,a){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ae(e,a,r=>!r._projectId&&(t!=null&&t._id)&&C(t._id)===C(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,le,s)}export{Ae as default,we as turboChargeResultIfSourceMap};
